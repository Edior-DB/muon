<!DOCTYPE html>
<!--
SPDX-FileCopyrightText: Stone Tickle <lattis@mochiro.moe>
SPDX-License-Identifier: GPL-3.0-only
-->

<html>
  <head>
    <meta charset="utf-8" />
    <title>muon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="muon_logo.svg" />
    <link rel="stylesheet" href="main.css" />
  </head>
  <body>
    <div>
      <div class="logo">
        <img src="muon_logo.svg" alt="muon logo" height=64></img>
        <div class="logo_text">
          <span>muon</span>
          <small>@version@-@vcs_tag@<br>targeting @meson_compat@</small>
        </div>
      </div>
    </div>
    <div>
      <p>A meson-compatible build system.</p>
    </div>
    <nav>
      <div>
        <a href="https://git.sr.ht/~lattis/muon">source</a>
      </div>
      <div>
        <a href="https://lists.sr.ht/~lattis/muon">mailing list</a>
      </div>
      <div>
        <a href="https://todo.sr.ht/~lattis/muon">issue tracker</a>
      </div>
      <div>
        <a href="ircs://irc.libera.chat/#muon">#muon on libera.chat</a>
      </div>
      <div>
        <a href="muon_ci.html">ci</a>
      </div>
      <div>
        <a href="https://play.muon.build">playground</a>
      </div>
      <div>
        docs
        <div>
          <a href="muon.1.html">muon.1</a>
        </div>
        <div>
          <a href="meson.build.5.html">meson.build.5</a>
        </div>
        <div>
          <a href="meson-reference.3.html">meson-reference.3</a>
        </div>
        <div>
          <a href="/releases/@version@/docs/status.html">implementation status</a>
        </div>
      </div>
      <div>
        <span class="downloads_title"><span>downloads</span> <span class="loader" id="loader"></span></span>
        <div id=downloads>
        </div>
      </div>
      <div>
        other links
        <div>
          <a href="https://repology.org/project/muon-meson/versions">repology</a>
        </div>
      </div>
    </nav>

    <script>
      (() => {
        const baseUri = 'https://muon.build/releases'
        var downloadsElement = document.getElementById('downloads');

        function sizeToH(b) {
          if (b > 1024 * 1024) {
            b /= 1024 * 1024;
            return `${b.toFixed(2)}mb`
          } else if (b > 1024) {
            b /= 1024;
            return `${b.toFixed(2)}kb`
          } else {
            return `${b}b`
          }
        }

        function sortReleases(list) {
          function verToNum(ver) {
            return ver.substr(1).split('.').map((n) => parseInt(n)).reduce((a, b) => a * 100 + b, 0);
          }

          list.sort((a, b) => {
            if (a.ver === 'edge') {
              return -1;
            } else {
              return verToNum(b.ver) - verToNum(a.ver) ;
            }
          });

          list.forEach((e) => {
            e.items.sort((a, b) => {
              if (a.itemPath < b.itemPath) {
                return -1;
              } else if (a.itemPath > b.itemPath) {
                return 1;
              } else {
                return 0;
              }
            });
          });
        }

        function doneLoading() {
          document.getElementById('loader').style.display = 'none';
        }

        function renderReleases(list) {
          sortReleases(list);

          list.forEach((e) => {
            var elem = document.createElement("details");
            downloadsElement.appendChild(elem);

            var summary = document.createElement("summary");
            summary.innerHTML = e.ver;
            elem.appendChild(summary);

            var ul = document.createElement("ul");
            elem.appendChild(ul);

            e.items.forEach((item) => {
              var li = document.createElement("li");
              ul.appendChild(li);

              var a = document.createElement("a");

              a.innerHTML = item.itemPath.substr(e.ver.length + 1);

              a.href = `${baseUri}/${item.itemPath}`;
              li.appendChild(a);

              var info = document.createElement("span");
              info.innerHTML = ` - ${sizeToH(item.item.size)}`;
              li.appendChild(info);
            });
          });
        }

        function fetchJson(uri) {
          return fetch(uri).then((response) => {
            if (!response.ok) {
              throw new Error("Failed with HTTP code " + response.status);
            }
            return response.json();
          })
        }

        function fetchAndAddItems(path) {
          return fetchJson(`${baseUri}/${path}`).then((dir) => {
            return Promise.all(dir.map((item) => {
              const itemPath =  `${path}/${item.name}`;
              if (item['type'] === 'directory') {
                return fetchAndAddItems(itemPath);
              } else if (item['type'] === 'file') {
                return new Promise((resolve, reject) => {
                  resolve({item: item, itemPath: itemPath});
                });
              }
            }));
          });
        }

        fetchJson(baseUri).then((versions) => {
          Promise.all(versions.map((ver) => {
            return fetchAndAddItems(ver.name);
          })).then((result) => {
            doneLoading();
            renderReleases(result.map((items, i) => ({
              ver: versions[i].name,
              items: items.flatMap((item) => item)
            })));
          });
        }).catch(err => {
          doneLoading();
          var p = document.createElement("p");
          p.innerHTML = `Error fetching releases: ${err}`;
          downloadsElement.appendChild(p);
        });
      })()
    </script>
  </body>
</html>
